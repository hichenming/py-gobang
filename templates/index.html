{% extends "base.html" %}

{% block css-block %}
<style type="text/css">
.gamemove-status {
    background-image: url("{{config.ConfigStaticPath}}/img/face-smile.png");
}
</style>
{% end %}

{% block container-fluid %}

    <div class="container-fluid">
    	<div class="row-fluid">
    		<div class="span9" id="game-div">
    			<div id="gamebar-div">
    				<div id="piece_sign_top" class=""><img id="his_status_img" src="{{config.ConfigStaticPath}}/img/help-browser-4.png" /></div>

    				<div id="piece_sign_bottom" class=""><img id="my_status_img" src="{{config.ConfigStaticPath}}/img/help-browser-4.png" /></div>
    			</div>
    			<canvas id="game-canvas" width="460px" height="460px" >糟糕，好像你的浏览器不支持canvas。换个谷歌浏览器再来试试吧</canvas>
    		</div>
    		<div class="span3" id="gamestatus-div">
                <div id="status-div">
                    <h5>说明</h5>
                    <blockquote>
                        <span>将当前地址发给朋友，邀请他一起玩吧</span>
                    </blockquote>
                    <blockquote>
                        <span>链接参数规则为：<br />/room-房间名</span>
                    </blockquote>

                    <h5>当前状态</h5>
                    <blockquote>
                        <span id="status-span" ></span>
                    </blockquote>
                    <h5>聊天</h5>
                    <div id="chat-div">
                        <ul>

                        </ul>

                        <input title="" type="text" class="" id="chat-input" placeholder="对他说点什么吧" onkeydown="javascript: if(event.keyCode==13) sendchat(); ">
                    </div>
                </div>
    		</div>
    	</div>

    </div>
    </div>

    <div id="alert-model-dom" class="modal hide fade">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h3 id="alert-title">游戏已结束</h3>
        </div>
        <div class="modal-body">
            <p id="alert-body"></p>
        </div>
        <div class="modal-footer">
            <a href="javascript:$('#alert-model-dom').modal('hide')" class="btn">关闭</a>
        </div>
    </div>

{% end %}

{% block javascript-block %}

    <script src="{{config.ConfigStaticPath}}/js/jquery-1.8.3.min.js"></script>
    <script src="{{config.ConfigStaticPath}}/js/bootstrap.min.js"></script>
    <script src="{{config.ConfigStaticPath}}/js/Game.js"></script>
    <script type="text/javascript">
    	var gamec = new GameCanvas();
        var is_waiting = {{ is_waiting and 'true' or 'false' }};
        var my_piece = {{ my_piece_id }};
        var his_piece = {{ my_piece_id == 1 and 2 or 1}};
        var room_name = '{{ cur_room.room_name }}';
        var room_status = {{ cur_room.status }};
        var game_pieces = new Array(); 
        var status_imgs = ['{{config.ConfigStaticPath}}/img/black.png', '{{config.ConfigStaticPath}}/img/white.png'];
        var gamesocket;

        for(i=0; i<=gamec.grid_count; i++){
            game_pieces[i] = new Array();
            for(j=0; j<=gamec.grid_count; j++){
                game_pieces[i][j] = 0;
            }
        }

        if(is_waiting ){
            $('#game-canvas').css('cursor', 'default');
        }
        if(room_status==0){
            $('#status-span').text('等待对方上线');
        }else{
            $('#status-span').text('游戏开始');
        }

        function getGridRowCol(pos){
            var cursorx = pos[0];
            var cursory = pos[1];
            var start_col = Math.floor((cursorx-gamec.out_width) / gamec.margin);
            var start_row = Math.floor((cursory-gamec.out_width) / gamec.margin);
            if (((cursorx-gamec.out_width) % gamec.margin) > (gamec.margin/2)) {
                start_col++;
            }
            if (((cursory-gamec.out_width) % gamec.margin) > (gamec.margin/2)) {
                start_row++;
            }
            return [start_row, start_col]
        }
    	function getCurPosition(e) {  
		    var x, y; 
		    if (e.pageX != undefined && e.pageY != undefined) {  
		      x = e.pageX;
		      y = e.pageY; 
		    } else {  
		      x = e.clientX + document.body.scrollLeft + document.documentElement.scrollLeft;
		      y = e.clientY + document.body.scrollTop + document.documentElement.scrollTop;
		    }  
		    x -= gamec.canvas.offsetLeft;
		    y -= gamec.canvas.offsetTop;
		    return [x, y];
	  	} 

	  	function canvasClickHandler(e){
            if(is_waiting){
                return false;
            }
	  		var canvas = document.getElementById('game-canvas');
	  		var pos = getCurPosition(e);
			rowcol = getGridRowCol(pos);
            row = rowcol[0]
            col = rowcol[1]
            if(game_pieces[row][col] != 0){
                return false;
            }
            gamemove(row, col);

	  	} 
        //哪一方该下棋的标记
        function initStartSign(){
            $('#piece_sign_top').removeClass('gamemove-status');
            $('#piece_sign_bottom').removeClass('gamemove-status');
            var piece_signs = $('#piece_sign_top');
            if(my_piece == 1){
                piece_signs = $('#piece_sign_bottom');   
            }
            piece_signs.addClass('gamemove-status');
        }

        function sendchat(){
            var content = $('#chat-input').val();
            $('#chat-input').val('');            
            if (!content || room_status != 1) return;
            $('#chat-div ul').append('<li class="mychat-li">'+content+'</li>');
            $('#chat-div ul').scrollTop($('#chat-div ul')[0].scrollHeight);
            gamesocket.send(JSON.stringify({
                room: room_name,
                content: content,
                'type':'on_chat',
            }));
        }

        function gamemove(row, col){
            gamec.drawPiece(row, col, my_piece);
            gamesocket.send(JSON.stringify({
                room: room_name,
                row: row,
                col: col,
                'type':'on_gamemove',
            }));
            is_waiting = true;
            game_pieces[row][col] = my_piece;
            $('#game-canvas').css('cursor', 'default');
            $('#piece_sign_bottom').removeClass('gamemove-status');
            $('#piece_sign_top').addClass('gamemove-status');
        }

        /**
         * 对方上线
         * @param  {string} msg 
         * @return {bool}     
         */
        function on_online(msg){

        }
        /**
         * 对方离线
         * @param  {string} msg 
         * @return {bool}     
         */
        function on_offline(msg){
            is_waiting = true;
            room_status = 0;
            $('#status-span').text('对方离线');
            $('#game-canvas').css('cursor', 'default');
            $('#piece_sign_top').removeClass('gamemove-status');
            $('#piece_sign_bottom').removeClass('gamemove-status');
            $('#alert-title').text('对方离线');
            $('#alert-model-dom').data('id', 0).modal('show');
        }
        /**
         * 对方走一步棋
         * @param  {string} msg 
         * @return {bool}     
         */
        function on_gamemove(msg){
            row = parseInt(msg.row);
            col = parseInt(msg.col);
            gamec.drawPiece(row, col, his_piece);
            game_pieces[row][col] = his_piece;
            $('#game-canvas').css('cursor', 'pointer');
            $('#piece_sign_top').removeClass('gamemove-status');
            $('#piece_sign_bottom').addClass('gamemove-status');
            is_waiting = false;
        }
        /**
         * 开始游戏
         * @param  {string} msg 
         * @return {bool}     
         */
        function on_gamestart(msg){
            is_waiting = false;
            room_status = 1;
            $('#status-span').text('对方上线，游戏开始');
            gamec.canvas.width = gamec.canvas.width;
            gamec.drawGrid();
            $('#his_status_img').attr('src', status_imgs[his_piece-1]);
            $('#my_status_img').attr('src', status_imgs[my_piece-1]);
            if(my_piece == 1){  //黑先白后
                $('#game-canvas').css('cursor', 'pointer');
            }
            initStartSign();
        }
        /**
         * 游戏结束
         * @param  {string} msg 
         * @return {bool}     
         */
        function on_gameover(msg){
            is_waiting = true;
            room_status = 2;
            $('#status-span').text('游戏结束');
            $('#piece_sign_top').removeClass('gamemove-status');
            $('#piece_sign_bottom').removeClass('gamemove-status');
            $('#game-canvas').css('cursor', 'default'); 
            pid = parseInt(msg.up)
            if (pid > 0 && pid != my_piece){
                row = parseInt(msg.row);
                col = parseInt(msg.col);
                gamec.drawPiece(row, col, his_piece);
                game_pieces[row][col] = his_piece;                  
            }
            $('#alert-title').text('游戏结束');
            $('#alert-model-dom').data('id', 0).modal('show');
        }
        /**
         * 聊天
         * @param  {string} msg 
         * @return {bool}     
         */
        function on_chat(msg){
            $('#chat-div ul').append('<li class="hischat-li">'+msg.content+'</li>');
            $('#chat-div ul').scrollTop($('#chat-div ul')[0].scrollHeight);
        }

        window.onbeforeunload = function () {
            gamesocket.close();
            // event.returnValue = "You will lose any unsaved content";
        }

        $(document).ready(function () {         
            gamec.canvas.addEventListener("click", canvasClickHandler, false);
            gamec.drawGrid();

            // $('#my_status_img').attr('src', status_imgs[my_piece-1]);
            if(room_status != 0){
               // $('#his_status_img').attr('src', status_imgs[his_piece-1]);
                initStartSign();
            }
          
            var WebSocket = window.WebSocket || window.MozWebSocket;
            if (WebSocket) {
                try {
                    gamesocket = new WebSocket('ws://{{config.ConfigDomain}}/gamesocket?room={{ cur_room.room_name }}&up={{my_piece_id}}');
                } catch (e) {
                    alert(e)
                }
            }

            if (gamesocket) {
                gamesocket.onopen = function(){  
                    //gamesocket.send(JSON.stringify({name:"yes"}));
                }  
                gamesocket.onmessage = function(event) {
                    console.log(event.data);
                    var msg = JSON.parse(event.data)
                    switch(msg.type){
                        case 'online':
                            on_online(msg);
                            break;
                        case 'offline':
                            on_offline(msg);
                            break;
                        case 'on_gamestart':
                            on_gamestart(msg);
                            break;
                        case 'on_gamemove':
                            on_gamemove(msg);
                            break;
                        case 'on_gameover':
                            on_gameover(msg);
                            break;
                        case 'on_chat':
                            on_chat(msg);
                            break;
                        default:
                            break;
                    }
                }
            }
        });
    </script>

{% end %}
